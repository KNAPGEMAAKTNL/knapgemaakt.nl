---
import Layout from "../../../layouts/Layout.astro";
import Footer from "../../../components/Footer.astro";
import BlogCard from "../../../components/blog/BlogCard.astro";
import BreadcrumbSchema from "../../../components/seo/BreadcrumbSchema.astro";
import { getCollection } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
	const allPosts = await getCollection("blog", ({ data }) => !data.draft);

	// Get all unique tags
	const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags))];

	return allTags.map((tag) => ({
		params: { tag: tag.toLowerCase().replace(/\s+/g, "-") },
		props: {
			tag,
			posts: allPosts
				.filter((post) => post.data.tags.includes(tag))
				.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
		},
	}));
}

interface Props {
	tag: string;
	posts: Awaited<ReturnType<typeof getCollection<"blog">>>;
}

const { tag, posts } = Astro.props;
const tagSlug = Astro.params.tag;

// Get all tags for the filter bar
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const allTags = [...new Set(allPosts.flatMap((post) => post.data.tags))].sort();

// SEO
const metaTitle = `${tag} | Blog | KNAP GEMAAKT.`;
const metaDescription = `Artikelen over ${tag.toLowerCase()}. Tips en inzichten voor ondernemers over webdesign en online zichtbaarheid.`;

const breadcrumbs = [
	{ name: "Home", url: "https://knapgemaakt.nl/" },
	{ name: "Blog", url: "https://knapgemaakt.nl/blog" },
	{ name: tag, url: `https://knapgemaakt.nl/blog/tag/${tagSlug}` },
];
---

<Layout title={metaTitle} description={metaDescription}>
	<BreadcrumbSchema items={breadcrumbs} />

	<main>
		<!-- Hero Section -->
		<section class="pt-32 pb-12 md:pb-16 px-6 md:px-12 lg:px-16 bg-canvas">
			<div class="max-w-3xl mx-auto text-center">
				<a
					href="/blog"
					class="inline-flex items-center gap-2 text-ink/40 hover:text-ink text-sm mb-6 transition-colors"
				>
					<span>&larr;</span>
					<span>Alle artikelen</span>
				</a>
				<h1 class="text-4xl md:text-5xl lg:text-6xl font-black tracking-tight leading-[0.95] mb-4">
					{tag}
				</h1>
				<p class="text-lg md:text-xl text-ink/60 max-w-xl mx-auto">
					{posts.length} {posts.length === 1 ? "artikel" : "artikelen"} over {tag.toLowerCase()}.
				</p>
			</div>
		</section>

		<!-- Tags Filter -->
		<section class="px-6 md:px-12 lg:px-16 bg-canvas pb-8">
			<div class="max-w-3xl mx-auto">
				<div class="flex flex-wrap justify-center gap-2">
					<a
						href="/blog"
						class="px-4 py-2 text-sm font-medium bg-ink/5 text-ink/70 rounded-full hover:bg-ink/10 transition-colors"
					>
						Alles
					</a>
					{allTags.map((t) => (
						<a
							href={`/blog/tag/${t.toLowerCase().replace(/\s+/g, "-")}`}
							class:list={[
								"px-4 py-2 text-sm font-medium rounded-full transition-colors",
								t === tag
									? "bg-ink text-canvas"
									: "bg-ink/5 text-ink/70 hover:bg-ink/10"
							]}
						>
							{t}
						</a>
					))}
				</div>
			</div>
		</section>

		<!-- Blog Posts List -->
		<section class="py-8 md:py-12 bg-canvas">
			<div class="max-w-3xl mx-auto px-6 md:px-12 lg:px-16">
				{posts.length > 0 ? (
					<div class="space-y-6">
						{posts.map((post) => (
							<BlogCard
								title={post.data.title}
								description={post.data.description}
								publishDate={post.data.publishDate}
								slug={post.slug}
								tags={post.data.tags}
								readingTime={post.data.readingTime}
							/>
						))}
					</div>
				) : (
					<div class="text-center py-16">
						<p class="text-ink/60 text-lg">
							Nog geen artikelen met deze tag.
						</p>
					</div>
				)}
			</div>
		</section>

		<Footer />
	</main>
</Layout>
