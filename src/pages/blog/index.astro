---
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";
import BlogCard from "../../components/blog/BlogCard.astro";
import BreadcrumbSchema from "../../components/seo/BreadcrumbSchema.astro";
import { getCollection } from "astro:content";

export const prerender = true;

// Get all non-draft blog posts, sorted by date (newest first)
const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
	(a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

// Separate featured post (most recent) from the rest
const featuredPost = sortedPosts[0];
const remainingPosts = sortedPosts.slice(1);

// Extract unique tags for filtering
const allTags = [...new Set(sortedPosts.flatMap((post) => post.data.tags))].sort();

// Calculate reading time for featured post
const featuredWordCount = featuredPost?.body.split(/\s+/).length || 0;
const featuredReadingTime = featuredPost?.data.readingTime || Math.ceil(featuredWordCount / 200);

// Format featured post date
const featuredDate = featuredPost?.data.publishDate.toLocaleDateString("nl-NL", {
	year: "numeric",
	month: "long",
	day: "numeric",
});

// SEO
const metaTitle = "Blog | Tips voor Ondernemers | KNAP GEMAAKT.";
const metaDescription =
	"Lees onze artikelen over webdesign, online zichtbaarheid en websites voor ondernemers. Praktische tips, prijsinformatie en vergelijkingen.";

const breadcrumbs = [
	{ name: "Home", url: "https://knapgemaakt.nl/" },
	{ name: "Blog", url: "https://knapgemaakt.nl/blog" },
];
---

<Layout title={metaTitle} description={metaDescription}>
	<BreadcrumbSchema items={breadcrumbs} />

	<main>
		<!-- Hero Section -->
		<section class="pt-32 pb-12 md:pb-16 px-6 md:px-12 lg:px-16 bg-canvas">
			<div class="max-w-3xl mx-auto text-center">
				<h1 class="text-4xl md:text-5xl lg:text-6xl font-black tracking-tight leading-[0.95] mb-4">
					Blog
				</h1>
				<p class="text-lg md:text-xl text-ink/60 max-w-xl mx-auto">
					Inzichten en tips over webdesign, websites bouwen en online groeien als ondernemer.
				</p>
			</div>
		</section>

		<!-- Tags Filter -->
		{allTags.length > 0 && (
			<section class="px-6 md:px-12 lg:px-16 bg-canvas pb-8">
				<div class="max-w-3xl mx-auto">
					<div class="flex flex-wrap justify-center gap-2">
						<a
							href="/blog"
							class="px-4 py-2 text-sm font-medium bg-ink text-canvas rounded-full hover:bg-ink/80 transition-colors"
						>
							Alles
						</a>
						{allTags.map((tag) => (
							<a
								href={`/blog/tag/${tag.toLowerCase().replace(/\s+/g, "-")}`}
								class="px-4 py-2 text-sm font-medium bg-ink/5 text-ink/70 rounded-full hover:bg-ink/10 transition-colors"
							>
								{tag}
							</a>
						))}
					</div>
				</div>
			</section>
		)}

		<!-- Featured Post -->
		{featuredPost && (
			<section class="px-6 md:px-12 lg:px-16 bg-canvas pb-8 md:pb-12">
				<div class="max-w-3xl mx-auto">
					<a href={`/blog/${featuredPost.slug}`} class="group block">
						<article class="bg-ink text-canvas rounded-2xl overflow-hidden hover:shadow-2xl transition-shadow duration-300">
							<!-- Featured image -->
							<div class="aspect-[2/1] bg-ink overflow-hidden">
								<img
									src={featuredPost.data.image}
									alt={featuredPost.data.imageAlt || featuredPost.data.title}
									class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-500"
									loading="eager"
									fetchpriority="high"
									decoding="async"
								/>
							</div>

							<div class="p-6 md:p-8">
								<!-- Tags -->
								<div class="flex flex-wrap gap-2 mb-4">
									{featuredPost.data.tags.slice(0, 3).map((tag) => (
										<span class="px-3 py-1 bg-acid/20 text-acid text-xs font-medium rounded-full">
											{tag}
										</span>
									))}
								</div>

								<!-- Title -->
								<h2 class="text-2xl md:text-3xl font-bold leading-tight mb-3 group-hover:text-acid transition-colors">
									{featuredPost.data.title}
								</h2>

								<!-- Description -->
								<p class="text-canvas/70 leading-relaxed mb-4 line-clamp-2">
									{featuredPost.data.description}
								</p>

								<!-- Meta -->
								<div class="flex items-center gap-4 text-sm text-canvas/50">
									<time datetime={featuredPost.data.publishDate.toISOString()}>
										{featuredDate}
									</time>
									<span class="w-1 h-1 bg-canvas/30 rounded-full"></span>
									<span>{featuredReadingTime} min lezen</span>
								</div>
							</div>
						</article>
					</a>
				</div>
			</section>
		)}

		<!-- Blog Posts List -->
		<section class="py-8 md:py-12 bg-canvas">
			<div class="max-w-3xl mx-auto px-6 md:px-12 lg:px-16">
				{remainingPosts.length > 0 ? (
					<div class="space-y-6">
						{remainingPosts.map((post) => (
							<BlogCard
								title={post.data.title}
								description={post.data.description}
								publishDate={post.data.publishDate}
								slug={post.slug}
								tags={post.data.tags}
								readingTime={post.data.readingTime}
							/>
						))}
					</div>
				) : sortedPosts.length === 0 ? (
					<div class="text-center py-16">
						<p class="text-ink/60 text-lg">
							Binnenkort verschijnen hier onze eerste artikelen.
						</p>
					</div>
				) : null}
			</div>
		</section>

		<Footer />
	</main>
</Layout>
